<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Open9 - Sistema de Biblioteca</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', 'Segoe UI', sans-serif; }
        body {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2a2a2a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- NAVEGAÇÃO --- */
        nav {
            max-width: 1200px;
            margin: 0 auto 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
        }
        .logo {
            background: linear-gradient(45deg, #b6ff01, #a0e600);
            color: #000;
            font-weight: 700;
            font-size: 24px;
            padding: 12px 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 6px 20px rgba(182, 255, 1, 0.4);
            transition: transform 0.3s ease;
        }
        .logo:hover { transform: scale(1.05); }
        .nav-buttons { display: flex; gap: 15px; }

        /* --- COMPONENTES --- */
        .section-page { 
            display: none; 
            max-width: 1200px; 
            margin: 0 auto; 
            text-align: center; 
            padding: 20px;
        }
        .active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h1 { 
            font-size: 3rem; 
            margin-bottom: 20px; 
            background: linear-gradient(45deg, #b6ff01, #a0e600); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-shadow: 0 2px 10px rgba(182, 255, 1, 0.3);
        }

        /* --- BOTÕES --- */
        .btn { border: none; border-radius: 25px; padding: 14px 24px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px; font-size: 15px; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-primary { background: linear-gradient(45deg, #b6ff01, #a0e600); color: #000; }
        .btn-secondary { background: #333; color: #fff; border: 1px solid #555; }
        .btn-danger { background: linear-gradient(45deg, #ff4444, #cc3333); color: #fff; border-radius: 12px; }
        .btn-edit { background: linear-gradient(45deg, #ffaa00, #e69500); color: #000; border-radius: 12px; }
        .btn:hover { transform: translateY(-3px); filter: brightness(1.1); box-shadow: 0 6px 20px rgba(0,0,0,0.5); }

        /* --- PAINEL DE UPLOAD --- */
        .admin-panel {
            background: #1f1f1f; padding: 50px; border-radius: 25px; max-width: 650px; margin: 50px auto; border: 1px solid #444; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 10px; color: #ccc; font-weight: 500; }
        .form-group input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #444; background: #2a2a2a; color: #fff; transition: border-color 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #b6ff01; box-shadow: 0 0 10px rgba(182, 255, 1, 0.3); }

        /* --- BUSCA E GRID --- */
        .search-container { max-width: 550px; margin: 0 auto 50px; position: relative; }
        .search-container input { width: 100%; padding: 18px 60px 18px 25px; border-radius: 35px; border: 2px solid #333; background: #1f1f1f; color: #fff; font-size: 16px; transition: border-color 0.3s ease; }
        .search-container input:focus { outline: none; border-color: #b6ff01; box-shadow: 0 0 15px rgba(182, 255, 1, 0.3); }
        .search-icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: #b6ff01; font-size: 18px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .card { background: #1f1f1f; padding: 25px; border-radius: 20px; border: 1px solid #333; transition: all 0.3s ease; text-align: left; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); border-color: #b6ff01; }
        .card img { width: 100%; height: 320px; object-fit: cover; border-radius: 12px; margin-bottom: 20px; }
        .card h3 { font-size: 1.3rem; margin-bottom: 8px; color: #fff; }
        .card p { color: #aaa; font-size: 0.95rem; }
        .card-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); z-index: 100; animation: modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: #1f1f1f; padding: 40px; border-radius: 20px; width: 90%; max-width: 450px; border: 2px solid #b6ff01; box-shadow: 0 10px 30px rgba(0,0,0,0.7); }
        .modal-content h3 { margin-bottom: 25px; color: #b6ff01; font-size: 1.5rem; }
        .modal-content input { width: 100%; padding: 12px; margin-bottom: 15px; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 10px; transition: border-color 0.3s ease; }
        .modal-content input:focus { outline: none; border-color: #b6ff01; }

        .status { margin-bottom: 25px; font-size: 16px; font-weight: 500; }
        .online { color: #00ff88; } 
        .offline { color: #ff4444; }

        @media (max-width: 768px) {
            nav { flex-direction: column; gap: 20px; }
            .grid { grid-template-columns: 1fr; }
            .admin-panel { padding: 30px; }
            h1 { font-size: 2.2rem; }
        }
    </style>
</head>
<body>

<nav>
    <div class="logo"><i class="fas fa-book-open"></i> Open9</div>
    <div class="nav-buttons">
        <button class="btn btn-secondary" onclick="showPage('adminPage')"><i class="fas fa-plus"></i> Upload</button>
        <button class="btn btn-primary" onclick="showPage('libraryPage')"><i class="fas fa-layer-group"></i> Biblioteca</button>
    </div>
</nav>

<section id="adminPage" class="section-page active">
    <h1>Painel de Gerenciamento</h1>
    <div class="status" id="serverStatus"><i class="fas fa-spinner fa-spin"></i> Verificando servidor...</div>

    <div class="admin-panel">
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label><i class="fas fa-book"></i> Nome do Livro</label>
                <input type="text" id="bookName" name="bookName" required placeholder="Digite o nome do livro">
            </div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> Autor</label>
                <input type="text" id="authorName" name="authorName" required placeholder="Digite o nome do autor">
            </div>
            <div class="form-group">
                <label><i class="fas fa-image"></i> Capa (Imagem)</label>
                <input type="file" id="coverFile" name="cover" accept="image/*" required>
            </div>
            <div class="form-group">
                <label><i class="fas fa-file-alt"></i> Arquivo (.epub)</label>
                <input type="file" id="epubFile" name="epub" accept=".epub" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-cloud-upload-alt"></i> Iniciar Upload
            </button>
            <div id="progressContainer" style="height: 10px; background: #333; margin-top: 20px; border-radius: 12px; overflow: hidden; display: none;">
                <div id="progressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #b6ff01, #a0e600); transition: width 0.3s ease;"></div>
            </div>
        </form>
    </div>
</section>

<section id="libraryPage" class="section-page">
    <h1>Biblioteca de Livros</h1>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Pesquisar por título ou autor...">
        <i class="fas fa-search search-icon"></i>
    </div>
    <div class="grid" id="bookGrid"></div>
</section>

<div class="modal" id="editModal">
    <div class="modal-content">
        <h3>Editar Livro</h3>
        <input type="text" id="editName" placeholder="Nome do livro">
        <input type="text" id="editAuthor" placeholder="Nome do autor">
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="saveEdit()" style="flex:1">Salvar</button>
            <button class="btn btn-secondary" onclick="closeModal()" style="flex:1">Cancelar</button>
        </div>
    </div>
</div>

<script>
const SERVER_URL = window.location.origin;
let allBooks = [];
let currentBookId = null;

function showPage(pageId) {
    document.querySelectorAll('.section-page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    if(pageId === 'libraryPage') loadBooks();
}

function capitalize(text) {
    return text.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
}

async function checkServer() {
    try { await fetch(`${SERVER_URL}/livros`); document.getElementById("serverStatus").innerHTML = "<i class='fas fa-check-circle online'></i> Servidor Online"; }
    catch { document.getElementById("serverStatus").innerHTML = "<i class='fas fa-times-circle offline'></i> Servidor Offline"; }
}

async function loadBooks() {
    try {
        const res = await fetch(`${SERVER_URL}/livros`);
        allBooks = await res.json();
        displayBooks(allBooks);
    } catch (e) { console.error(e); alert("Erro ao carregar livros."); }
}

function displayBooks(books) {
    const grid = document.getElementById("bookGrid");
    grid.innerHTML = books.length ? "" : "<p style='grid-column: 1/-1; color: #aaa;'>Nenhum livro encontrado.</p>";
    books.forEach(book => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
            <img src="${SERVER_URL}/uploads/${book.cover}" alt="Capa de ${book.bookName}">
            <h3>${capitalize(book.bookName)}</h3>
            <p>${capitalize(book.authorName)}</p>
            <div class="card-btns">
                <a href="${SERVER_URL}/uploads/${book.epub}" target="_blank" class="btn btn-primary"><i class="fas fa-download"></i> Baixar</a>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-edit" style="flex:1" onclick="openEdit('${book.id}','${book.bookName}','${book.authorName}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger" style="flex:1" onclick="deleteBook('${book.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append("bookName", document.getElementById("bookName").value.trim());
    formData.append("authorName", document.getElementById("authorName").value.trim());
    formData.append("cover", document.getElementById("coverFile").files[0]);
    formData.append("epub", document.getElementById("epubFile").files[0]);
    if (!formData.get("bookName") || !formData.get("authorName") || !formData.get("cover") || !formData.get("epub")) { alert("Preencha todos os campos."); return; }

    const progBar = document.getElementById("progressBar");
    const progCont = document.getElementById("progressContainer");
    progCont.style.display = "block";

    const xhr = new XMLHttpRequest();
    xhr.open("POST", `${SERVER_URL}/upload`);
    xhr.upload.onprogress = (e) => progBar.style.width = ((e.loaded / e.total) * 100) + "%";
    xhr.onload = () => {
        if (xhr.status === 200) { alert("Livro adicionado com sucesso!"); document.getElementById("uploadForm").reset(); progCont.style.display = "none"; showPage('libraryPage'); }
        else { alert("Erro ao enviar. Tente novamente."); progCont.style.display = "none"; }
    };
    xhr.onerror = () => { alert("Erro de rede. Verifique sua conexão."); progCont.style.display = "none"; };
    xhr.send(formData);
});

document.getElementById("searchInput").addEventListener("input", function() {
    const term = this.value.toLowerCase();
    displayBooks(allBooks.filter(b => b.bookName.toLowerCase().includes(term) || b.authorName.toLowerCase().includes(term)));
});

async function deleteBook(id) {
    if (!confirm("Remover este livro permanentemente?")) return;
    try { await fetch(`${SERVER_URL}/delete/${id}`, { method: "DELETE" }); loadBooks(); }
    catch (e) { console.error(e); alert("Erro ao deletar livro."); }
}

function openEdit(id, name, author) { currentBookId = id; document.getElementById("editName").value = name; document.getElementById("editAuthor").value = author; document.getElementById("editModal").style.display = "flex"; }
function closeModal() { document.getElementById("editModal").style.display = "none"; }

async function saveEdit() {
    const newName = document.getElementById("editName").value.trim();
    const newAuthor = document.getElementById("editAuthor").value.trim();
    if (!newName || !newAuthor) { alert("Preencha todos os campos."); return; }
    try {
        await fetch(`${SERVER_URL}/edit/${currentBookId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ bookName: newName, authorName: newAuthor }) });
        closeModal(); loadBooks();
    } catch (e) { console.error(e); alert("Erro ao editar livro."); }
}

checkServer();
</script>
</body>
</html>
